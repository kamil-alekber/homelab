---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: explo
  namespace: media-services
  labels:
    app: explo
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: explo
  template:
    metadata:
      labels:
        app: explo
    spec:
      initContainers:
      - name: setup-directories
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          [ ! -d /storage/shared/explo ] && mkdir -p /storage/shared/explo
          [ ! -d /storage/media/explo ] && mkdir -p /storage/media/explo
          echo "Directory setup completed successfully"
        volumeMounts:
        - name: shared-storage
          mountPath: /storage
      containers:
      - name: explo
        image: ghcr.io/lumepart/explo:latest
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        env:
        - name: TZ
          value: "UTC"
        - name: WEEKLY_EXPLORATION_SCHEDULE
          value: "15 00 * * 2"
        - name: WEEKLY_EXPLORATION_FLAGS
          value: ""
        # Uncomment to enable Weekly Jams
        # - name: WEEKLY_JAMS_SCHEDULE
        #   value: "30 00 * * 1"
        # - name: WEEKLY_JAMS_FLAGS
        #   value: "--playlist=weekly-jams --download-mode=skip"
        # Uncomment to enable Daily Jams
        # - name: DAILY_JAMS_SCHEDULE
        #   value: "15 01 * * *"
        # - name: DAILY_JAMS_FLAGS
        #   value: "--playlist=daily-jams --download-mode=skip"
        # Uncomment for testing
        # - name: EXECUTE_ON_START
        #   value: "false"
        # - name: START_FLAGS
        #   value: "--persist=false"
        volumeMounts:
        - name: explo-env
          mountPath: /opt/explo/.env
          subPath: .env
        - name: shared-storage
          mountPath: /data
          subPath: media/explo
        - name: shared-storage
          mountPath: /slskd
          subPath: media/downloads/slskd
          readOnly: true
        # Uncomment if you need cookies.txt for yt-dlp
        # - name: explo-cookies
        #   mountPath: /opt/explo/cookies.txt
        #   subPath: cookies.txt
        resources:
          requests:
            memory: "256Mi"
            cpu: "50m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: shared-storage
        persistentVolumeClaim:
          claimName: media-shared-storage
      - name: explo-env
        secret:
          secretName: explo-env
      # Uncomment if you need cookies.txt
      # - name: explo-cookies
      #   configMap:
      #     name: explo-cookies
